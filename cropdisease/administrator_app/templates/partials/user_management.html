{% block content %} {% load static %}{% load humanize %}

<!-- User Management Tab -->
<div class="tab-pane" id="users">
  <div class="container my-4">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center flex-wrap"
      >
        <h5 class="mb-0 mb-2 mb-sm-0 me-4">
          <i class="fa-solid fa-users fs-4"></i>
          User Management
        </h5>
        <div class="d-flex">
          <button
            class="btn btn-primary btn-sm me-2"
            data-bs-toggle="modal"
            data-bs-target="#addUserModal"
          >
            <i class="fas fa-plus me-1"></i> Add User
          </button>
          <button class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-download me-1"></i> Export
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6 mb-2 mb-md-0">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Search users..."
              />
              <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex justify-content-md-end justify-content-start">
              <div class="dropdown me-2">
                <button
                  class="btn btn-outline-secondary dropdown-toggle"
                  type="button"
                  id="filterDropdown"
                  data-bs-toggle="dropdown"
                >
                  <i class="fas fa-filter me-1"></i> Filter
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                  <li><a class="dropdown-item" href="#">Farmers</a></li>
                  <li><a class="dropdown-item" href="#">Agronomists</a></li>
                  <li>
                    <a class="dropdown-item" href="#">Extension Workers</a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li><a class="dropdown-item" href="#">Active Users</a></li>
                  <li><a class="dropdown-item" href="#">Inactive Users</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover" >
            <thead>
              <tr>
                <th>Profile</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td class="d-flex align-items-center gap-2">
                  {% if 'default_profile.png' in user.profile_image.name %}
                    <div class="rounded-circle d-flex align-items-center justify-content-center" 
                         style="width: 45px; height: 45px; background-color: #1e720f; color: white; font-weight: bold;">
                      {{ user.get_first_initial }}
                    </div>
                  {% else %}
                    <img
                      src="{{ user.profile_image.url }}"
                      alt="{{ user.user_name }}"
                      class="rounded-circle"
                      style="width: 45px; height: 45px; object-fit: cover"
                    />
                  {% endif %}
                  <span class="profile-details">
                    <h5 class="fs-6 mb-0">{{user.user_name}}</h5>
                    <small class="text-muted">{{user.email}}</small>
                  </span>
                </td>
                <td>
                    <span class="badge 
                        {% if user.role == 'farmer' %}bg-primary
                        {% else %}bg-warning
                        {% endif %}">
                        {{ user.get_role_display }}
                    </span>
                </td>
                <td>
                    <span class="badge 
                        {% if user.is_active %}bg-success
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ user.is_active|yesno:'Active,Inactive' }}
                    </span>
                </td>

                <!-- Date Joined Column (used instead of Last Active) -->
                <td>{{ user.date_joined|naturaltime }}</td>

                <td>
                  <div class="d-flex gap-1">
                    <button
                      class="btn btn-sm btn-outline-primary me-1"
                      data-bs-toggle="modal"
                      data-bs-target="#userModal{{ user.id }}"
                    >
                      <i class="fas fa-expand"></i>
                    </button>
                    {% if user.is_active %}
                      <button
                        class="btn btn-sm btn-outline-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#deactivateConfirmationModal{{ user.id }}"
                      >
                        <i class="fa-solid fa-user-slash"></i>
                      </button>
                    {% else %}
                      <button
                        class="btn btn-sm btn-outline-success"
                        data-bs-toggle="modal"
                        data-bs-target="#reactivateConfirmationModal{{ user.id }}"
                      >
                        <i class="fa-solid fa-user-check"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">No users found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">Previous</a>
            </li>
            <li class="page-item active">
              <a class="page-link" href="#">1</a>
            </li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
              <a class="page-link" href="#">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

    <!-- Deactivate Confirmation Modal -->
  {% for user in users %}
  <div
    class="modal fade"
    id="deactivateConfirmationModal{{ user.id }}"
    tabindex="-1"
    aria-labelledby="deactivateConfirmationModalLabel{{ user.id }}"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deactivateConfirmationModalLabel{{ user.id }}">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Confirmation to Deactivate
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to deactivate {{user.user_name}}?
          </p>
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            The user will be marked as inactive and cannot log in.
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <form method="POST" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <button type="submit" class="btn btn-danger" id="confirmDeactivateBtn{{ user.id }}">
              Deactivate User
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- Reactivate Confirmation Modal -->
  {% for user in users %}
  <div
    class="modal fade"
    id="reactivateConfirmationModal{{ user.id }}"
    tabindex="-1"
    aria-labelledby="reactivateConfirmationModalLabel{{ user.id }}"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="reactivateConfirmationModalLabel{{ user.id }}">
            <i class="fas fa-check-circle me-2"></i>
            Confirmation to Reactivate
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to reactivate {{user.user_name}}?
          </p>
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            The user will be marked as active and can log in again.
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <form method="POST" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <button type="submit" class="btn btn-success" id="confirmReactivateBtn{{ user.id }}">
              Reactivate User
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <style>
    input:focus,
    select:focus,
    textarea:focus {
      background-color: transparent;
    }
    .form-floating > .form-select {
      padding-top: 1.625rem;
      padding-bottom: 0.625rem;
    }
  </style>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title d-flex align-items-center gap-3" id="addUserModalLabel">
                      <i class="fa-regular fa-user fs-4"></i> Add New User
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <form method="POST" id="addUserForm" autocomplete="off" action="{% url 'admin_add_user' %}">
                      {% csrf_token %}

                      <div class="form-floating mb-3">
                          <input type="text" class="form-control" id="userName" name="user_name" placeholder="Enter full name" required />
                          <label for="userName" class="d-flex align-items-center gap-2">
                              <i class="fa-regular fa-user"></i> User Name
                          </label>
                      </div>

                      <div class="form-floating mb-3">
                          <input type="email" class="form-control" id="userEmail" name="email" placeholder="Enter email" required />
                          <label for="userEmail" class="d-flex align-items-center gap-2">
                              <i class="fa-regular fa-envelope"></i> Email Address
                          </label>
                      </div>

                      <div class="form-floating dropdown mb-3">
                          <input type="text" class="form-control dropdown-toggle" id="userRoleDisplay" placeholder="Select a role" data-bs-toggle="dropdown" readonly required />
                          <input type="hidden" name="role" id="userRoleValue" />
                          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userRoleDisplay">
                              <li><a class="dropdown-item" href="#" data-role="farmer">Farmer</a></li>
                              <li><a class="dropdown-item" href="#" data-role="agronomist">Agronomist</a></li>
                          </ul>
                          <label for="userRoleDisplay">User Role</label>
                      </div>

                      <div class="form-floating mb-3">
                          <input type="tel" class="form-control" id="userPhone" name="phone" placeholder="Enter phone number" />
                          <label for="userPhone" class="d-flex align-items-center gap-1">
                            <i class="fa-solid fa-phone"></i> Phone Number
                          </label>
                      </div>

                      <div class="form-floating mb-3" id="experience-wrapper" style="display: none;">
                          <input type="number" class="form-control" id="experience" name="experience" placeholder="Enter experience (years)" />
                          <label for="experience" class="d-flex align-items-center gap-1">
                              <i class="fa-regular fa-calendar"></i> Years of Experience
                          </label>
                      </div>

                      <div class="form-floating mb-3">
                          <input type="password" class="form-control" id="password" name="password1" placeholder="Enter password" autocomplete="new-password" required />
                          <label for="password"># Password</label>
                      </div>
                      <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="confirmPassword" name="password2" placeholder="Confirm Password" required>
                        <label for="confirmPassword">
                          # Confirm Password
                        </label>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" form="addUserForm" class="btn btn-primary">Save User</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Custom CSS for transparent background on focus -->
  <style>
    .form-control:focus,
    .form-select:focus {
      background-color: transparent !important;
      border-color: #0a500a;
      box-shadow: 0 0 0 0.25rem rgba(30, 114, 15, 0.25);
    }
    .btn-primary {
      border-color: #0a500a;
    }
    .btn-primary:hover {
      border-color: #0a500a;
      background-color: #0a500a;
    }
  </style>


  <script>
      document.addEventListener("DOMContentLoaded", function () {
          const roleDropdownItems = document.querySelectorAll("#addUserModal .dropdown-item");
          const userRoleDisplayInput = document.getElementById("userRoleDisplay");
          const userRoleValueInput = document.getElementById("userRoleValue"); // The hidden input
          const experienceWrapper = document.getElementById("experience-wrapper");
          const experienceInput = document.getElementById("experience");

          roleDropdownItems.forEach((item) => {
              item.addEventListener("click", function (event) {
                  event.preventDefault();
                  const roleValue = this.getAttribute("data-role");
                  const displayText = this.textContent;

                  // Update both the visible and hidden inputs
                  userRoleDisplayInput.value = displayText;
                  userRoleValueInput.value = roleValue; // This sends the correct value to Django

                  // Toggle experience field
                  if (roleValue === 'agronomist') {
                      experienceWrapper.style.display = 'block';
                      experienceInput.required = true;
                  } else {
                      experienceWrapper.style.display = 'none';
                      experienceInput.required = false;
                      experienceInput.value = '';
                  }
              });
          });
      });


  </script>


  <!-- Individual User Modals -->
  {% for user in users %}
  <div
    class="modal fade"
    id="userModal{{ user.id }}"
    tabindex="-1"
    aria-labelledby="userModalLabel{{ user.id }}"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalLabel{{ user.id }}">User Details</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-3 text-center mb-3">
              {% if 'default_profile.png' in user.profile_image.name %}
                <div class="rounded-circle d-flex align-items-center justify-content-center mb-2" 
                     style="width: 120px; height: 120px; background-color: #1e720f; color: white; font-weight: bold; font-size: 2rem; margin: 0 auto;">
                  {{ user.get_first_initial }}
                </div>
              {% else %}
                <img
                  src="{{ user.profile_image.url }}"
                  alt="{{ user.user_name }}"
                  class="rounded-circle mb-2"
                  style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);"
                />
              {% endif %}
              <h5>{{ user.user_name }}</h5>
              <p class="text-muted mb-1">{{ user.get_role_display }}</p>
              <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                {{ user.is_active|yesno:'Active,Inactive' }}
              </span>
            </div>
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <p class="mb-1 text-muted">Email</p>
                  <p class="mb-0">{{ user.email }}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <p class="mb-1 text-muted">Phone</p>
                  <p class="mb-0">{{ user.phone|default:'N/A' }}</p>
                </div>
                {% if user.role == 'farmer' %}
                <div class="col-md-6 mb-3">
                  <p class="mb-1 text-muted">Location</p>
                  <p class="mb-0">{{user.location|default:'No Location'}}</p>
                </div>
                {% endif %}
                {% if user.role == 'agronomist' %}
                <div class="col-md-6 mb-3">
                  <p class="mb-1 text-muted">Experience</p>
                  <p class="mb-0">{{ user.experience|default:'N/A' }} years</p>
                </div>
                {% endif %}
                <div class="col-md-6 mb-3">
                  <p class="mb-1 text-muted">Date Joined</p>
                  <p class="mb-0">{{ user.date_joined|date:'M j, Y' }}</p>
                </div>
                <div class="col-12 mb-3">
                  <p class="mb-1 text-muted">Bio</p>
                  <p class="mb-0">{{ user.bio|default:'No bio available' }}</p>
                </div>
                {% if user.role == 'farmer' %}
                <div class="col-12">
                  <p class="mb-1 text-muted">Farm Size</p>
                  <p class="mb-0">8 acres</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

</div>
{% endblock %}
